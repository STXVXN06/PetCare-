
services:
  # ========================================
  # MongoDB Replica Set (3 nodos)
  # ========================================
  
  mongo1:
    image: mongo:6
    hostname: mongo1
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo1-data:/data/db
    networks:
      - petcare-network
    deploy:
      placement:
        constraints:
          - node.role == manager
      

  mongo2:
    image: mongo:6
    hostname: mongo2
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo2-data:/data/db
    networks:
      - petcare-network
    deploy:
      placement:
        constraints:
          - node.role == manager
      

  mongo3:
    image: mongo:6
    hostname: mongo3
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo3-data:/data/db
    networks:
      - petcare-network
    deploy:
      placement:
        constraints:
          - node.role == manager
      

  # ========================================
  # R√©plicas de la API Spring Boot
  # ========================================
  
  app:
    image: petcare-app:latest
    environment:
      - INSTANCE={{.Task.Slot}}
      - PORT=3000
      - DB_HOST=mongo1,mongo2,mongo3
      - DB_PORT=27017
      - DB_NAME=petcare
      - DB_REPLICA_SET=rs0
    networks:
      - petcare-network
    deploy:
      mode: replicated
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
      update_config:
        parallelism: 1
        delay: 10s
  

    # ========================================
  # Autoscaler
  # ========================================

  autoscaler:
    image: swarm-autoscaler:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - petcare-network
      
        
  # ========================================
  # Balanceador de Carga Nginx
  # ========================================
  
  nginx:
    image: nginx:stable-alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - petcare-network
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
  
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    command: [
      "--nginx.scrape-uri", "http://nginx/nginx_status"
    ]
    ports:
      - "9113:9113"
    depends_on:
      - nginx
    networks:
      - petcare-network
    deploy:
      mode: replicated
      replicas: 1

  


  # ========================================
  # Monitoreo cAdvisor - Prometheus - Grafana
  # ========================================

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports:
      - "8081:8080"
    networks:
      - petcare-network
    volumes:
      - /:/rootfs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/:/var/lib/docker:ro
    deploy:
      mode: global

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/rules.yml:/etc/prometheus/rules.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    depends_on:
      - alertmanager
    networks:
      - petcare-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
  
  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--log.level=debug'  # üîç Para ver errores
    networks:
      - petcare-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    depends_on:
      - prometheus
    deploy:
      mode: replicated
      replicas: 1
    networks:
      - petcare-network


  
  
  

# ========================================
# Redes y Vol√∫menes
# ========================================

networks:
  petcare-network:
    driver: overlay
    attachable: true

volumes:
  mongo1-data:
    driver: local
  mongo2-data:
    driver: local
  mongo3-data:
    driver: local